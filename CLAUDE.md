# Universal File Converter

## Repository
- GitHub: https://github.com/LinguiniPanini/universal-file-converter

## Project Structure
- `backend/` — Python FastAPI API (venv at `backend/venv/`)
- `frontend/` — React + Vite + Tailwind CSS
- `nginx/` — Reverse proxy config
- `scripts/` — Cron jobs (S3 cleanup)
- `deploy/` — AWS deployment scripts (2-step: infrastructure + server config)
- `docs/plans/` — Design doc and implementation plan

## Commands
- Backend tests: `cd backend && source venv/bin/activate && python -m pytest -v`
- Frontend build: `cd frontend && npm run build`
- Backend dev server: `cd backend && source venv/bin/activate && uvicorn app.main:app --reload`
- Frontend dev server: `cd frontend && npm run dev`

## Deployment
- **Step 1 (local):** `./deploy/01-setup-aws.sh` — Creates all AWS infrastructure (EC2, S3, IAM, Security Group)
- **Step 2 (SSH into EC2):** `sudo S3_BUCKET=<bucket> CORS_ORIGINS=http://<ip> bash deploy/02-setup-server.sh`
- Deploy config saved to `deploy/.env.deploy` (gitignored)
- SSH key saved to `deploy/file-converter-key.pem` (gitignored)
- Production URL: `http://<EC2-public-ip>`
- Useful commands on EC2:
  - `sudo systemctl status file-converter` — Check backend status
  - `journalctl -u file-converter -f` — Stream backend logs
  - `sudo systemctl restart file-converter` — Restart backend
  - `sudo systemctl reload nginx` — Reload Nginx config

## Environment Variables
- `S3_BUCKET` — S3 bucket name (default: `file-converter-bucket`)
- `AWS_REGION` — AWS region (default: `us-east-1`)
- `CORS_ORIGINS` — Comma-separated allowed origins (default: `http://localhost:5173`)

## System Dependencies (EC2/Linux)
- `libreoffice-writer` — DOCX->PDF conversion (headless)
- `libmagic1` — MIME type detection via python-magic
- `nginx` — Reverse proxy
- `Node.js 20 LTS` — Frontend build

## Architecture
- API routes: `backend/app/routes/` (upload, convert, download)
- Services: `backend/app/services/` (validator, s3, image_converter, document_converter)
- S3 singleton: import `s3_service` from `app.services.s3`, don't create new instances
- Rate limiter: import `limiter` from `app.limiter` (separate module to avoid circular imports)
- CORS: configured via `CORS_ORIGINS` env var, never use `"*"`
- Nginx: serves React build at `/`, proxies `/api/` to FastAPI on port 8000
- systemd: manages FastAPI process (auto-restart, boot start, log management)
- Cron: runs `scripts/cleanup_s3.py` every 15 min to delete S3 objects older than 1 hour

## Key Files
- `backend/app/main.py` — FastAPI app entry point, router registration, CORS/rate-limit setup
- `backend/app/config.py` — Settings class with S3, file size, MIME type config
- `backend/app/limiter.py` — Shared rate limiter instance
- `frontend/src/App.jsx` — React root, wires FileUploader -> ConversionPanel
- `frontend/vite.config.js` — Dev proxy (`/api` -> `localhost:8000`)
- `deploy/01-setup-aws.sh` — AWS infrastructure setup (run locally)
- `deploy/02-setup-server.sh` — Server configuration (run on EC2 via SSH)
- `nginx/file-converter.conf` — Reverse proxy config
- `scripts/cleanup_s3.py` — S3 cleanup cron script (reads S3_BUCKET from env var)

## Code Style
- This is an educational project — comment code extensively so it serves as learning material
- All comments are in Spanish
- Explain the "why" behind decisions, not just the "what"
- Backend: Python, FastAPI. Routes return Pydantic `response_model`, raise `HTTPException` for errors
- Services are pure functions (image_converter, document_converter) or singleton classes (S3Service)
- Frontend: functional components with hooks, Tailwind utility classes, no CSS modules
- Deploy scripts: bash with `set -euo pipefail`, idempotent (safe to re-run)

## Testing
- S3 tests use `moto` mock (`@mock_aws` + `s3_client` fixture in `conftest.py`)
- Route tests mock `s3_service` via `@patch("app.routes.<module>.s3_service")`
- Binary test fixtures in `backend/test_fixtures/` (generated by `tests/generate_fixtures.py`)
- LibreOffice tests use `@pytest.mark.skipif(shutil.which("libreoffice") is None)`
- 30 tests total across 7 test files

## Security Patterns
- Always sanitize filenames with `os.path.basename()` before S3 keys
- Validate job_id as UUID format before S3 operations
- Store validated MIME type in S3 object metadata, don't re-detect
- Cap file reads: `await file.read(MAX_SIZE + 1)`, reject if oversized
- IAM Instance Profile: EC2 gets S3 permissions automatically, no access keys on server
- S3 bucket: public access fully blocked, lifecycle policy auto-deletes after 24h
- Security Group: only ports 22 (SSH) and 80 (HTTP) open
- Nginx: security headers (X-Content-Type-Options, X-Frame-Options, X-XSS-Protection)

## Not Implemented (V2)
- PDF -> DOCX conversion (pdf2docx removed from requirements)
- OCR (Tesseract)
- Batch conversion
- Watermarks
- Resize UI (backend supports it, frontend doesn't expose it)
- HTTPS/SSL (would add via Let's Encrypt + certbot)
